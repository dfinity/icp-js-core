---
title: Upgrading to v5
description: Upgrade your project to v5 of the ICP JavaScript SDK.
sidebar:
  label: v5
  order: 0
next:
  label: Overview
  link: /core/latest/
---

This release completes the migration of all `@dfinity/*` packages into `@icp-sdk/core`, upgrades the IC API endpoints to their latest versions, and introduces several new features for subnet and certificate management. This guide will help you upgrade your project from v4 to v5.

## TL;DR

- **New API versions**: Agent now uses the latest IC API endpoints: `/api/v4` for calls and `/api/v3` for queries/read_state.
- **Local replica upgrade required**: Use dfx >=v0.30.1 or PocketIC >=v11.0.0.
- **Peer dependencies removed**: `@dfinity/*` packages are no longer peer dependencies. Remove them before upgrading.

## Before You Begin

Before upgrading to v5, you **must** remove the `@dfinity/*` peer dependencies from your project. These packages are now fully integrated into `@icp-sdk/core` and are no longer required as separate dependencies.

```shell
npm remove @dfinity/{agent,candid,identity,identity-secp256k1,principal}
```

Then, upgrade `@icp-sdk/core` to the latest version:

```shell
npm install @icp-sdk/core@latest
```

## Breaking Changes

### Source Code Moved to `@icp-sdk/core`

In v4, `@icp-sdk/core` re-exported the `@dfinity/*` packages as peer dependencies. In v5, the source code of all core packages has been moved directly into `@icp-sdk/core`. This means:

- You no longer need to install `@dfinity/agent`, `@dfinity/candid`, `@dfinity/identity`, `@dfinity/identity-secp256k1`, or `@dfinity/principal` as separate packages.
- All imports should use `@icp-sdk/core/*` submodules, as described in the [v4 upgrading guide](https://js.icp.build/core/latest/upgrading/v4/).

### API Version Upgrades

The agent now uses the latest IC API endpoints:

- **Call requests** now use `/api/v4` instead of `/api/v3`
- **Query and read_state requests** now use `/api/v3` instead of `/api/v2`

If you were using internal types related to these API versions, you'll need to update them:

| Old Name                        | New Name                        |
| ------------------------------- | ------------------------------- |
| `v3ResponseBody`                | `v4ResponseBody`                |
| `isV3ResponseBody`              | `isV4ResponseBody`              |
| `HttpV3ApiNotSupportedErrorCode`| `HttpV4ApiNotSupportedErrorCode`|

> If you're developing locally, make sure you upgrade to [dfx v0.30.1](https://github.com/dfinity/sdk/releases/tag/0.30.1) or later.

> If you're using PocketIC for testing, upgrade to [v11](https://github.com/dfinity/pocketic/releases/tag/11.0.0) or later.

### Certificate Verification: `canisterId` Replaced with `principal`

The `canisterId` option in `Certificate.create` has been replaced with a more generic `principal` option that supports both subnet IDs and canister IDs for certificate verification.

**Before:**

```typescript
import { Certificate } from '@icp-sdk/core/agent';

const canisterId = Principal.fromText('uqqxf-5h777-77774-qaaaa-cai');

const certificate = await Certificate.create({
  certificate: certBytes,
  rootKey: agent.rootKey,
  canisterId,
});
```

**After:**

```typescript
import { Certificate } from '@icp-sdk/core/agent';

const canisterId = Principal.fromText('uqqxf-5h777-77774-qaaaa-cai');

const certificate = await Certificate.create({
  certificate: certBytes,
  principal: { canisterId },
  rootKey: agent.rootKey,
});

// or

const subnetId = Principal.fromText('jtdsg-3h6gi-hs7o5-z2soi-43w3z-soyl3-ajnp3-ekni5-sw553-5kw67-nqe');

const certificate = await Certificate.create({
  certificate: certBytes,
  principal: { subnetId },
  rootKey: agent.rootKey,
});
```

## New Features

### Subnet State Methods

New methods have been added to `HttpAgent` for interacting with subnet state:

```typescript
import { HttpAgent } from '@icp-sdk/core/agent';

const agent = await HttpAgent.create();

// Get the subnet ID for a canister
const subnetId = await agent.getSubnetIdFromCanister(canisterId);

// Read subnet state directly
const subnetState = await agent.readSubnetState(subnetId, paths);

// Sync time with a specific subnet
await agent.syncTimeWithSubnet(subnetId);
```

### Canister Ranges Lookup

New utility functions for looking up canister ranges from certificate trees:

```typescript
import {
  lookupCanisterRanges,
  lookupCanisterRangesFallback,
  decodeCanisterRanges,
} from '@icp-sdk/core/agent';

const canisterId = Principal.fromText('uqqxf-5h777-77774-qaaaa-cai');
const subnetId = Principal.fromText('jtdsg-3h6gi-hs7o5-z2soi-43w3z-soyl3-ajnp3-ekni5-sw553-5kw67-nqe');

const certificate = await Certificate.create({
  certificate: certBytes,
  principal: { canisterId },
  rootKey: agent.rootKey,
});

const canisterRanges = lookupCanisterRanges({ subnetId, tree: certificate.tree, canisterId });

const ranges = decodeCanisterRanges(canisterRanges);

console.log(ranges);
```

### Subnet Status Utility

A new `SubnetStatus` namespace has been introduced to request subnet information directly from the IC public API:

```typescript
import { SubnetStatus } from '@icp-sdk/core/agent';

const subnetId = Principal.fromText('jtdsg-3h6gi-hs7o5-z2soi-43w3z-soyl3-ajnp3-ekni5-sw553-5kw67-nqe');

const status = await SubnetStatus.request({
  subnetId,
  paths: ['time', 'nodeKeys'],
  agent,
});

const time = status.get('time');
const nodeKeys = status.get('nodeKeys');

console.log(time);
console.log(nodeKeys);
```

### Certificate Utilities

- `getSubnetIdFromCertificate`: Read the subnet ID from a certificate tree
- `IC_STATE_ROOT_DOMAIN_SEPARATOR`: Exported constant for certificate verification

### `@dfinity/auth-client` Deprecated

The `@dfinity/auth-client` package has been deprecated. Please migrate to [`@icp-sdk/auth`](https://js.icp.build/auth/latest/upgrading/v4).

**Before:**

```typescript
import { AuthClient } from '@dfinity/auth-client';

const authClient = await AuthClient.create();
```

**After:**

Please refer to the [`@icp-sdk/auth` documentation](https://js.icp.build/auth/latest/) for the new authentication API.

---

For a complete list of all changes, fixes, and improvements in this release, please refer to the [CHANGELOG](https://js.icp.build/core/v5/changelog/).
